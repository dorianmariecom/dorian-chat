#!/usr/bin/env ruby
# frozen_string_literal: true

require "json"
require "net/http"
require "uri"
require "git"

if ARGV.first == "--help" || ARGV.first == "-h"
  abort "USAGE: chat INPUT, ... | chat"
end

TOKEN_FILE = File.join(Dir.home, ".chat")

if File.exist?(TOKEN_FILE)
  TOKEN = File.read(TOKEN_FILE).strip
else
  print "token: "
  TOKEN = gets.strip
  File.write(TOKEN_FILE, TOKEN)
  puts "token written to #{TOKEN_FILE}"
end

INPUT = ARGV.any? ? ARGV.join(" ") : $stdin.each_line.to_a.join

uri = URI("https://api.openai.com/v1/chat/completions")
http = Net::HTTP.new(uri.host, uri.port)
http.use_ssl = true

request =
  Net::HTTP::Post.new(
    uri.path,
    {
      "Content-Type" => "application/json",
      "Authorization" => "Bearer #{TOKEN}"
    }
  )

request.body = {
  model: "gpt-4o",
  messages: [
    { role: "user", content: INPUT }
  ]
}.to_json

response = http.request(request)
json = JSON.parse(response.body)
output = json.dig("choices", 0, "message", "content").strip
puts output
