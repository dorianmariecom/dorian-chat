#!/usr/bin/env ruby
# frozen_string_literal: true

require "json"
require "net/http"
require "uri"
require "git"

abort "USAGE: commit" if ARGV.any?

TOKEN_FILE = File.join(Dir.home, ".commit")
PROMPT = "simple, clear, short, lowercase commit message for the following diff:"

if File.exist?(TOKEN_FILE)
  TOKEN = File.read(TOKEN_FILE).strip
else
  print "token: "
  TOKEN = gets.strip
  File.write(TOKEN_FILE, TOKEN)
  puts "token written to #{TOKEN_FILE}"
end

STAGED = `git diff --staged`

abort "no staged files" if STAGED.strip.empty?

uri = URI("https://api.openai.com/v1/chat/completions")
http = Net::HTTP.new(uri.host, uri.port)
http.use_ssl = true

request = Net::HTTP::Post.new(uri.path, {
  "Content-Type" => "application/json",
  "Authorization" => "Bearer #{TOKEN}"
})

request.body = {
  model: "gpt-4o",
  messages: [
    { role: "system", content: PROMPT },
    { role: "user", content: STAGED }
  ],
}.to_json

response = http.request(request)
json = JSON.parse(response.body)
message = json.dig('choices', 0, 'message', 'content').strip
Git.open(".").commit(message)
puts message
